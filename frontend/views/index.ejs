<!DOCTYPE html>
<html lang="en"> 
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="views/css/bootstrap.css">
  <title>Destiny - Astro</title>
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col-7 me-10">
        <h1>Destiny Score</h1>
        <div class="row">
          <div class="col-9">
            <h2 id="destiny-score">
              <%= results[0]["first_person"] + " - " + Math.round(results[0]["destiny_score"] * 100) + " - " + results[0]["second_person"] %>
            </h3>
          </div>
          <div class="col-3">
            <button class="btn btn-primary" id="next-couple" onClick="nextCouple()">Next Couple</button>
          </div>
        </div>
        

        <div class="row">
          <div class="col-4">
            <ul>
              <li>Positive Score: <span id="pos_score"><%= results[0]["aspect"]["pos_score"] %></span></li>
              <li>Negative Score: <span id="neg_score"><%= results[0]["aspect"]["neg_score"] %></span></li>
              <li>Matching Score: <span id="matching_score"><%= results[0]["aspect"]["matching_score"] %></span></li>
              <li>House Score: <span id="house_score"><%= results[0]["aspect"]["house_score"] %></span></li>
              <li>Planet Score: <span id="planet_score"><%= results[0]["aspect"]["planet_score"] %></span></li>
            </ul>
          </div>

          <div class="col-4">
            <ul>
              <li>Num of +1: <span id="num_score_p1"><%= results[0]["aspect"]["num_score_p1"] %></span></li>
              <li>Num of +2: <span id="num_score_p2"><%= results[0]["aspect"]["num_score_p2"] %></span></li>
              <li>Num of +3: <span id="num_score_p3"><%= results[0]["aspect"]["num_score_p3"] %></span></li>
              <li>Num of +4: <span id="num_score_p4"><%= results[0]["aspect"]["num_score_p4"] %></span></li>
            </ul>
          </div>

          <div class="col-4">
            <ul>
              <li>Num of -1: <span id="num_score_n1"><%= results[0]["aspect"]["num_score_n1"] %></span></li>
              <li>Num of -2: <span id="num_score_n2"><%= results[0]["aspect"]["num_score_n2"] %></span></li>
              <li>Num of -3: <span id="num_score_n3"><%= results[0]["aspect"]["num_score_n3"] %></span></li>
              <li>Num of -4: <span id="num_score_n4"><%= results[0]["aspect"]["num_score_n4"] %></span></li>
            </ul>
          </div>
        </div>
        

        <p id="key-sentence" class="text-primary mb-20"><%= results[0]["message"] %></p>

        <h4>Full Fate Score Interpretation</h4>
        <div class="row">
          <div class="col-6">
            <h5>Harmonious</h5>
            <ul id="full-harmonies">
              <% for(var i=0; i<results[0]["harmonies"].length; i++) { %>
                <li id="fh-key-<%= i%>">
                  <%= results[0]["harmonies"][i][0] + " (" + results[0]["harmonies"][i][1] + ")" %>
                </li>
              <% } %>
            </ul>
          </div>
          <div class="col-6">
            <h5>Challenges</h5>
            <ul id="full-challenges">
              <% for(var i=0; i<results[0]["challenges"].length; i++) { %>
                <li id="fc-key-<%= i%>">
                  <%= results[0]["challenges"][i][0] + " (" + results[0]["challenges"][i][1] + ")" %>
                </li>
              <% } %>
            </ul>
          </div>
        </div>
      </div>

      <div class="col-5">
        <canvas id="radar-chart" height="400"></canvas>

        <h4>Fate Score Interpretation</h4>
        <h5>Harmonious</h5>
        <ul>
          <% for(var i=0; i<5; i++) { %>
            <li id="h-key-<%= i%>">
              <%= results[0]["harmonies"][i][0] + " (" + results[0]["harmonies"][i][1] + ")" %>
            </li>
          <% } %>
        </ul>
        <h5>Challenges</h5>
        <ul>
          <% for(var i=0; i<5; i++) { %>
            <li id="c-key-<%= i%>">
              <%= results[0]["challenges"][i][0] + " (" + results[0]["challenges"][i][1] + ")" %>
            </li>
          <% } %>
        </ul>
      </div>
    </div>
  </div>
</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.0.0-beta/chart.min.js"></script>

<script>
  var index = 0;
  var chart = null
  var results = <%- JSON.stringify(results) %>;

  var compa_data = [
    results[0]["compas"]["Commitment"],
    results[0]["compas"]["Emotional"],
    results[0]["compas"]["Intellectual"],
    results[0]["compas"]["Communication"],
    results[0]["compas"]["Lifestyle"],
    results[0]["compas"]["Physical"],
  ]
  var incompa_data = [
    results[0]["incompas"]["Commitment"],
    results[0]["incompas"]["Emotional"],
    results[0]["incompas"]["Intellectual"],
    results[0]["incompas"]["Communication"],
    results[0]["incompas"]["Lifestyle"],
    results[0]["incompas"]["Physical"],
  ]
  
  var chart = new Chart("radar-chart", {
    type: 'radar',
    data: {
      labels: ["Commitment", "Emotional", "Intellectual", "Communication", "Lifestyle", "Physical"],
      datasets: [
        {
          label: "Compatibility",
          data: compa_data,
          backgroundColor: "rgba(255,99,132,0.2)",
          borderColor: "rgba(255,99,132,1)"
        },
        {
          label: "Incompatibility",
          data: incompa_data,
          backgroundColor: "rgba(99,132,255,0.2)",
          borderColor: "rgba(99,132,255,1)"
        },
      ]
    },
    options: {
      scale: {
        ticks: {
          min: 0,
          max: 30,
          stepSize: 4
        },
        gridLines: {
          lineWidth: 2,
          color: "lightgreen",
          borderDash: context => context.index == 6 ? [] : [6, 4]
        },
      }
    }
  });

  function nextCouple() {
    index ++;
    if (index >= results.length) {
      index = 0
    }

    astro_content(results[index], chart)
  }

  function astro_content(data, chart) {
    document.getElementById("destiny-score").innerHTML = 
      data["first_person"] + " - " + Math.round(data["destiny_score"] * 100) + " - " + data["second_person"];

    document.getElementById("key-sentence").innerHTML = data["message"];

    for (let key in data["aspect"]) {
      document.getElementById(key).innerHTML = data["aspect"][key];
    }

    for (let i=0; i<5; i++) {
      document.getElementById("h-key-" + i).innerHTML = data["harmonies"][i][0] + " (" + data["harmonies"][i][1] + ")";
      document.getElementById("c-key-" + i).innerHTML = data["challenges"][i][0] + " (" + data["challenges"][i][1] + ")";
    }

    data["harmonies"].forEach((item, i) => {
      let e = document.getElementById("fh-key-" + i)
      if (e !== null) {
        e.innerHTML = item[0] + " (" + item[1] + ")";
      } else {
        e = document.createElement('li');
        e.setAttribute('id', "fh-key-" + i);
        e.textContent = item[0] + " (" + item[1] + ")";

        let parent = document.getElementById("full-harmonies");
        parent.appendChild(e);
      }
    })

    data["challenges"].forEach((item, i) => {
      let e = document.getElementById("fc-key-" + i)
      if (e !== null) {
        e.innerHTML = item[0] + " (" + item[1] + ")";
      } else {
        e = document.createElement('li');
        e.setAttribute('id', "fc-key-" + i);
        e.textContent = item[0] + " (" + item[1] + ")";

        let parent = document.getElementById("full-challenges");
        parent.appendChild(e);
      }
    })


    compa_data = [
      data["compas"]["Commitment"],
      data["compas"]["Emotional"],
      data["compas"]["Intellectual"],
      data["compas"]["Communication"],
      data["compas"]["Lifestyle"],
      data["compas"]["Physical"],
    ]
    incompa_data = [
      data["incompas"]["Commitment"],
      data["incompas"]["Emotional"],
      data["incompas"]["Intellectual"],
      data["incompas"]["Communication"],
      data["incompas"]["Lifestyle"],
      data["incompas"]["Physical"],
    ]

    chart.data.datasets[0].data = compa_data;
    chart.data.datasets[1].data = incompa_data;
    chart.update();
  }
</script>

</body>
</html>